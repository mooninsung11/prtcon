import pandas as pd
from tkinter import Tk
from tkinter.filedialog import askopenfilename
import pymysql

def main():
    # 1. íŒŒì¼ ì—´ê¸° (íŒŒì¼ ë‹¤ì´ì–¼ë¡œê·¸)
    root = Tk()
    root.withdraw()
    file_path = askopenfilename(
        title="CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”",
        filetypes=[("CSV files", "*.csv")]
    )
    root.destroy()
    if not file_path:
        print("íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return

    # 2. CSV ì½ê¸° (êµ¬ë¶„ì íƒ­/ì‰¼í‘œ ìë™ ì¸ì‹)
    try:
        df = pd.read_csv(file_path, encoding='utf-8')
    except:
        df = pd.read_csv(file_path, encoding='cp949')  # í•œê¸€ê¹¨ì§ì‹œ

    print(f"\nğŸ“‚ ë¶ˆëŸ¬ì˜¨ íŒŒì¼: {file_path}\n")
    print(df.head())
    print(df.columns)

    # 3. NaN â†’ None (MySQL NULLë¡œ ë“¤ì–´ê°€ê²Œ)
    df = df.where(pd.notnull(df), None)

    # 4. ì»¬ëŸ¼ ë§¤í•‘: CSV â†’ Hospital í…Œì´ë¸”
    df_db = pd.DataFrame({
        'name': df['FCLTY_NM'],
        'address': df['RDNMADR_NM'],
        'opening_hours': df['OPER_TIME'],
        'services': df['FCLTY_INFO_DC'],
        'avg_rating': None,   # CSVì— ì—†ìœ¼ë‹ˆ ì „ë¶€ Noneìœ¼ë¡œ
        'latitude': df['LC_LA'],
        'longitude': df['LC_LO']
    })

    # 5. DB ì—°ê²°
    conn = pymysql.connect(
        host='localhost',
        user='root',
        password='1234',   # ë³¸ì¸ DB ë¹„ë°€ë²ˆí˜¸
        db='test',         # ë³¸ì¸ DB ì´ë¦„
        charset='utf8'
    )
    cursor = conn.cursor()

    # 6. INSERT ì¿¼ë¦¬ (Hospital í…Œì´ë¸”)
    sql = """
    INSERT INTO hospital (name, address, opening_hours, services, avg_rating, latitude, longitude)
    VALUES (%s, %s, %s, %s, %s, %s, %s)
    """

    count = 0
    for _, row in df_db.iterrows():
        # ìœ„ë„, ê²½ë„, ê¸°íƒ€ ìˆ«ì ì „ì²˜ë¦¬
        latitude = float(row['latitude']) if row['latitude'] not in (None, '', ' ') else None
        longitude = float(row['longitude']) if row['longitude'] not in (None, '', ' ') else None

        cursor.execute(sql, (
            row['name'],
            row['address'],
            row['opening_hours'],
            row['services'],
            row['avg_rating'],
            latitude,
            longitude
        ))
        count += 1

    conn.commit()
    cursor.close()
    conn.close()
    print(f"âœ… ì´ {count}ê°œ ë ˆì½”ë“œë¥¼ Hospital í…Œì´ë¸”ì— ì‚½ì…í–ˆìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main()
